import os
import telebot
import random
import time
import json
from datetime import datetime, timedelta
from openai import OpenAI

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ---
BOT_TOKEN = os.getenv("BOT_TOKEN") or os.getenv("TELEGRAM_TOKEN")
CHANNEL_ID = os.getenv("CHANNEL_ID")  # "@my_channel" –∏–ª–∏ "-1001234567890"
SLEEP_SECONDS = int(os.getenv("SLEEP_SECONDS", "180"))  # –ø–∞—É–∑–∞ –º–µ–∂–¥—É –ø–æ—Å—Ç–∞–º–∏ (—Å–µ–∫)
HISTORY_FILE = "used_combinations.json"
HISTORY_DAYS = int(os.getenv("HISTORY_DAYS", "30"))

if not BOT_TOKEN:
    raise SystemExit("‚ùå –û—à–∏–±–∫–∞: –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è BOT_TOKEN (–∏–ª–∏ TELEGRAM_TOKEN) –Ω–µ –∑–∞–¥–∞–Ω–∞.")
if not CHANNEL_ID:
    raise SystemExit("‚ùå –û—à–∏–±–∫–∞: –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è CHANNEL_ID –Ω–µ –∑–∞–¥–∞–Ω–∞.")

bot = telebot.TeleBot(BOT_TOKEN)
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

# --- –ú–µ—Å—è—Ü—ã –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞—Ç—ã ---
MONTHS = {
    1: "—è–Ω–≤–∞—Ä—è", 2: "—Ñ–µ–≤—Ä–∞–ª—è", 3: "–º–∞—Ä—Ç–∞", 4: "–∞–ø—Ä–µ–ª—è",
    5: "–º–∞—è", 6: "–∏—é–Ω—è", 7: "–∏—é–ª—è", 8: "–∞–≤–≥—É—Å—Ç–∞",
    9: "—Å–µ–Ω—Ç—è–±—Ä—è", 10: "–æ–∫—Ç—è–±—Ä—è", 11: "–Ω–æ—è–±—Ä—è", 12: "–¥–µ–∫–∞–±—Ä—è"
}

# --- –ö–æ–ª–æ–¥–∞ –¢–∞—Ä–æ (78 –∫–∞—Ä—Ç) ---
tarot_cards = [
    "–®—É—Ç ‚Äî –Ω–æ–≤—ã–µ –Ω–∞—á–∏–Ω–∞–Ω–∏—è, —Å–≤–æ–±–æ–¥–∞", "–ú–∞–≥ ‚Äî —Å–∏–ª–∞ –≤–æ–ª–∏, –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ", "–í–µ—Ä—Ö–æ–≤–Ω–∞—è –ñ—Ä–∏—Ü–∞ ‚Äî –∏–Ω—Ç—É–∏—Ü–∏—è, —Ç–∞–π–Ω—ã",
    "–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞ ‚Äî –∏–∑–æ–±–∏–ª–∏–µ, –∑–∞–±–æ—Ç–∞", "–ò–º–ø–µ—Ä–∞—Ç–æ—Ä ‚Äî –ø–æ—Ä—è–¥–æ–∫, –≤–ª–∞—Å—Ç—å", "–ò–µ—Ä–æ—Ñ–∞–Ω—Ç ‚Äî —Ç—Ä–∞–¥–∏—Ü–∏–∏, –æ–±—É—á–µ–Ω–∏–µ",
    "–í–ª—é–±–ª—ë–Ω–Ω—ã–µ ‚Äî –≤—ã–±–æ—Ä, –≥–∞—Ä–º–æ–Ω–∏—è", "–ö–æ–ª–µ—Å–Ω–∏—Ü–∞ ‚Äî –¥–≤–∏–∂–µ–Ω–∏–µ, –ø–æ–±–µ–¥–∞", "–°–∏–ª–∞ ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å—Ç–æ–π–∫–æ—Å—Ç—å, –º—É–∂–µ—Å—Ç–≤–æ",
    "–û—Ç—à–µ–ª—å–Ω–∏–∫ ‚Äî –ø–æ–∏—Å–∫ –∏—Å—Ç–∏–Ω—ã, —É–µ–¥–∏–Ω–µ–Ω–∏–µ", "–ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã ‚Äî –ø–µ—Ä–µ–º–µ–Ω—ã, —Å—É–¥—å–±–∞", "–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å ‚Äî –±–∞–ª–∞–Ω—Å, —á–µ—Å—Ç–Ω–æ—Å—Ç—å",
    "–ü–æ–≤–µ—à–µ–Ω–Ω—ã–π ‚Äî –ø–µ—Ä–µ–æ—Ü–µ–Ω–∫–∞, –Ω–æ–≤—ã–µ –≤–∑–≥–ª—è–¥—ã", "–°–º–µ—Ä—Ç—å ‚Äî —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è, –∫–æ–Ω–µ—Ü –∏ –Ω–∞—á–∞–ª–æ", "–£–º–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å ‚Äî –≥–∞—Ä–º–æ–Ω–∏—è, —Ç–µ—Ä–ø–µ–Ω–∏–µ",
    "–î—å—è–≤–æ–ª ‚Äî –∏—Å–∫—É—à–µ–Ω–∏—è, –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏", "–ë–∞—à–Ω—è ‚Äî —Ä–∞–∑—Ä—É—à–µ–Ω–∏–µ, –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ", "–ó–≤–µ–∑–¥–∞ ‚Äî –Ω–∞–¥–µ–∂–¥–∞, –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ",
    "–õ—É–Ω–∞ ‚Äî –∏–ª–ª—é–∑–∏–∏, —Å–Ω—ã", "–°–æ–ª–Ω—Ü–µ ‚Äî —Ä–∞–¥–æ—Å—Ç—å, —É—Å–ø–µ—Ö", "–°—É–¥ ‚Äî –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ, –≤–æ–∑—Ä–æ–∂–¥–µ–Ω–∏–µ", "–ú–∏—Ä ‚Äî –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ, —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å",
    # –ñ–µ–∑–ª—ã
    "–¢—É–∑ –ñ–µ–∑–ª–æ–≤ ‚Äî —ç–Ω–µ—Ä–≥–∏—è, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏", "–î–≤–æ–π–∫–∞ –ñ–µ–∑–ª–æ–≤ ‚Äî –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –≤—ã–±–æ—Ä", "–¢—Ä–æ–π–∫–∞ –ñ–µ–∑–ª–æ–≤ ‚Äî –æ–∂–∏–¥–∞–Ω–∏—è, –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã",
    "–ß–µ—Ç–≤—ë—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤ ‚Äî –ø—Ä–∞–∑–¥–Ω–∏–∫, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å", "–ü—è—Ç—ë—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤ ‚Äî –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è, –≤—ã–∑–æ–≤", "–®–µ—Å—Ç—ë—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤ ‚Äî –ø–æ–±–µ–¥–∞, –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ",
    "–°–µ–º—ë—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤ ‚Äî –∑–∞—â–∏—Ç–∞, —É–ø–æ—Ä—Å—Ç–≤–æ", "–í–æ—Å—å–º—ë—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤ ‚Äî —Å–∫–æ—Ä–æ—Å—Ç—å, –Ω–æ–≤–æ—Å—Ç–∏", "–î–µ–≤—è—Ç–∫–∞ –ñ–µ–∑–ª–æ–≤ ‚Äî —Å—Ç–æ–π–∫–æ—Å—Ç—å, –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ",
    "–î–µ—Å—è—Ç–∫–∞ –ñ–µ–∑–ª–æ–≤ ‚Äî —Ç—è–∂–µ—Å—Ç—å, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å", "–ü–∞–∂ –ñ–µ–∑–ª–æ–≤ ‚Äî —ç–Ω—Ç—É–∑–∏–∞–∑–º, –Ω–∞—á–∞–ª–æ", "–†—ã—Ü–∞—Ä—å –ñ–µ–∑–ª–æ–≤ ‚Äî —Ä–µ—à–∏–º–æ—Å—Ç—å, –¥–≤–∏–∂–µ–Ω–∏–µ",
    "–ö–æ—Ä–æ–ª–µ–≤–∞ –ñ–µ–∑–ª–æ–≤ ‚Äî —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å, –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ", "–ö–æ—Ä–æ–ª—å –ñ–µ–∑–ª–æ–≤ ‚Äî –ª–∏–¥–µ—Ä—Å—Ç–≤–æ, —Å–∏–ª–∞",
    # –ö—É–±–∫–∏
    "–¢—É–∑ –ö—É–±–∫–æ–≤ ‚Äî —ç–º–æ—Ü–∏–∏, –ª—é–±–æ–≤—å", "–î–≤–æ–π–∫–∞ –ö—É–±–∫–æ–≤ ‚Äî —Å–æ—é–∑, –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ", "–¢—Ä–æ–π–∫–∞ –ö—É–±–∫–æ–≤ ‚Äî —Ä–∞–¥–æ—Å—Ç—å, –¥—Ä—É–∑—å—è",
    "–ß–µ—Ç–≤—ë—Ä–∫–∞ –ö—É–±–∫–æ–≤ ‚Äî —Å–∫—É–∫–∞, –Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ", "–ü—è—Ç—ë—Ä–∫–∞ –ö—É–±–∫–æ–≤ ‚Äî —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ, –ø–æ—Ç–µ—Ä—è", "–®–µ—Å—Ç—ë—Ä–∫–∞ –ö—É–±–∫–æ–≤ ‚Äî –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è, –ø—Ä–æ—à–ª–æ–µ",
    "–°–µ–º—ë—Ä–∫–∞ –ö—É–±–∫–æ–≤ ‚Äî –∏–ª–ª—é–∑–∏–∏, –≤—ã–±–æ—Ä", "–í–æ—Å—å–º—ë—Ä–∫–∞ –ö—É–±–∫–æ–≤ ‚Äî —É—Ö–æ–¥, –ø–æ–∏—Å–∫ —Å–º—ã—Å–ª–∞", "–î–µ–≤—è—Ç–∫–∞ –ö—É–±–∫–æ–≤ ‚Äî —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ, –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",
    "–î–µ—Å—è—Ç–∫–∞ –ö—É–±–∫–æ–≤ ‚Äî –≥–∞—Ä–º–æ–Ω–∏—è, —Å–µ–º—å—è", "–ü–∞–∂ –ö—É–±–∫–æ–≤ ‚Äî –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ, —á—É–≤—Å—Ç–≤–∞", "–†—ã—Ü–∞—Ä—å –ö—É–±–∫–æ–≤ ‚Äî —Ä–æ–º–∞–Ω—Ç–∏–∫–∞, –º–µ—á—Ç—ã",
    "–ö–æ—Ä–æ–ª–µ–≤–∞ –ö—É–±–∫–æ–≤ ‚Äî —Å–æ—Å—Ç—Ä–∞–¥–∞–Ω–∏–µ, —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å", "–ö–æ—Ä–æ–ª—å –ö—É–±–∫–æ–≤ ‚Äî –∑—Ä–µ–ª–æ—Å—Ç—å, –±–∞–ª–∞–Ω—Å",
    # –ú–µ—á–∏
    "–¢—É–∑ –ú–µ—á–µ–π ‚Äî –∏—Å—Ç–∏–Ω–∞, —è—Å–Ω–æ—Å—Ç—å", "–î–≤–æ–π–∫–∞ –ú–µ—á–µ–π ‚Äî –≤—ã–±–æ—Ä, —Å–æ–º–Ω–µ–Ω–∏—è", "–¢—Ä–æ–π–∫–∞ –ú–µ—á–µ–π ‚Äî –±–æ–ª—å, —Ä–∞–∑—Ä—ã–≤",
    "–ß–µ—Ç–≤—ë—Ä–∫–∞ –ú–µ—á–µ–π ‚Äî –æ—Ç–¥—ã—Ö, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ", "–ü—è—Ç—ë—Ä–∫–∞ –ú–µ—á–µ–π ‚Äî –∫–æ–Ω—Ñ–ª–∏–∫—Ç, –ø–æ—Ä–∞–∂–µ–Ω–∏–µ", "–®–µ—Å—Ç—ë—Ä–∫–∞ –ú–µ—á–µ–π ‚Äî –¥–≤–∏–∂–µ–Ω–∏–µ –≤–ø–µ—Ä—ë–¥",
    "–°–µ–º—ë—Ä–∫–∞ –ú–µ—á–µ–π ‚Äî —Ö–∏—Ç—Ä–æ—Å—Ç—å, –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å", "–í–æ—Å—å–º—ë—Ä–∫–∞ –ú–µ—á–µ–π ‚Äî –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, —Å—Ç—Ä–∞—Ö", "–î–µ–≤—è—Ç–∫–∞ –ú–µ—á–µ–π ‚Äî —Ç—Ä–µ–≤–æ–≥–∞, –∫–æ—à–º–∞—Ä—ã",
    "–î–µ—Å—è—Ç–∫–∞ –ú–µ—á–µ–π ‚Äî –∫–æ–Ω–µ—Ü, –ø–æ—Ä–∞–∂–µ–Ω–∏–µ", "–ü–∞–∂ –ú–µ—á–µ–π ‚Äî –ª—é–±–æ–ø—ã—Ç—Å—Ç–≤–æ, –∏–¥–µ–∏", "–†—ã—Ü–∞—Ä—å –ú–µ—á–µ–π ‚Äî –Ω–∞–ø–æ—Ä, –∏–º–ø—É–ª—å—Å",
    "–ö–æ—Ä–æ–ª–µ–≤–∞ –ú–µ—á–µ–π ‚Äî –º—É–¥—Ä–æ—Å—Ç—å, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å", "–ö–æ—Ä–æ–ª—å –ú–µ—á–µ–π ‚Äî —Ä–∞—Å—Å—É–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –ª–æ–≥–∏–∫–∞",
    # –ü–µ–Ω—Ç–∞–∫–ª–∏
    "–¢—É–∑ –ü–µ–Ω—Ç–∞–∫–ª–µ–π ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–µ –±–ª–∞–≥–∞", "–î–≤–æ–π–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π ‚Äî –±–∞–ª–∞–Ω—Å, –∞–¥–∞–ø—Ç–∞—Ü–∏—è", "–¢—Ä–æ–π–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π ‚Äî —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ",
    "–ß–µ—Ç–≤—ë—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π ‚Äî —É–¥–µ—Ä–∂–∞–Ω–∏–µ, –∫–æ–Ω—Ç—Ä–æ–ª—å", "–ü—è—Ç—ë—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π ‚Äî —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏, –ª–∏—à–µ–Ω–∏—è", "–®–µ—Å—Ç—ë—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π ‚Äî –ø–æ–º–æ—â—å, —â–µ–¥—Ä–æ—Å—Ç—å",
    "–°–µ–º—ë—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π ‚Äî —Ç–µ—Ä–ø–µ–Ω–∏–µ, –æ–∂–∏–¥–∞–Ω–∏–µ", "–í–æ—Å—å–º—ë—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π ‚Äî —Ä–∞–±–æ—Ç–∞, –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ", "–î–µ–≤—è—Ç–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π ‚Äî —É—Å–ø–µ—Ö, —Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å",
    "–î–µ—Å—è—Ç–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π ‚Äî –±–æ–≥–∞—Ç—Å—Ç–≤–æ, —Å–µ–º—å—è", "–ü–∞–∂ –ü–µ–Ω—Ç–∞–∫–ª–µ–π ‚Äî —É—á–µ–±–∞, –ø—Ä–∞–∫—Ç–∏—á–Ω–æ—Å—Ç—å", "–†—ã—Ü–∞—Ä—å –ü–µ–Ω—Ç–∞–∫–ª–µ–π ‚Äî –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å, —Ç—Ä—É–¥–æ–ª—é–±–∏–µ",
    "–ö–æ—Ä–æ–ª–µ–≤–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π ‚Äî –∑–∞–±–æ—Ç–∞, —É—é—Ç", "–ö–æ—Ä–æ–ª—å –ü–µ–Ω—Ç–∞–∫–ª–µ–π ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, –¥–æ—Å—Ç–∞—Ç–æ–∫"
]

# --- –ó–Ω–∞–∫–∏ –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å ---
signs = [
    "‚ôàÔ∏è –û–≤–µ–Ω", "‚ôâÔ∏è –¢–µ–ª–µ—Ü", "‚ôäÔ∏è –ë–ª–∏–∑–Ω–µ—Ü—ã", "‚ôãÔ∏è –†–∞–∫",
    "‚ôåÔ∏è –õ–µ–≤", "‚ôçÔ∏è –î–µ–≤–∞", "‚ôéÔ∏è –í–µ—Å—ã", "‚ôèÔ∏è –°–∫–æ—Ä–ø–∏–æ–Ω",
    "‚ôêÔ∏è –°—Ç—Ä–µ–ª–µ—Ü", "‚ôëÔ∏è –ö–æ–∑–µ—Ä–æ–≥", "‚ôíÔ∏è –í–æ–¥–æ–ª–µ–π", "‚ôìÔ∏è –†—ã–±—ã"
]

compatibility = {
    "–û–≤–µ–Ω": "–õ–µ–≤, –°—Ç—Ä–µ–ª–µ—Ü", "–¢–µ–ª–µ—Ü": "–î–µ–≤–∞, –ö–æ–∑–µ—Ä–æ–≥", "–ë–ª–∏–∑–Ω–µ—Ü—ã": "–í–µ—Å—ã, –í–æ–¥–æ–ª–µ–π",
    "–†–∞–∫": "–°–∫–æ—Ä–ø–∏–æ–Ω, –†—ã–±—ã", "–õ–µ–≤": "–û–≤–µ–Ω, –°—Ç—Ä–µ–ª–µ—Ü", "–î–µ–≤–∞": "–¢–µ–ª–µ—Ü, –ö–æ–∑–µ—Ä–æ–≥",
    "–í–µ—Å—ã": "–ë–ª–∏–∑–Ω–µ—Ü—ã, –í–æ–¥–æ–ª–µ–π", "–°–∫–æ—Ä–ø–∏–æ–Ω": "–†–∞–∫, –†—ã–±—ã", "–°—Ç—Ä–µ–ª–µ—Ü": "–û–≤–µ–Ω, –õ–µ–≤",
    "–ö–æ–∑–µ—Ä–æ–≥": "–¢–µ–ª–µ—Ü, –î–µ–≤–∞", "–í–æ–¥–æ–ª–µ–π": "–ë–ª–∏–∑–Ω–µ—Ü—ã, –í–µ—Å—ã", "–†—ã–±—ã": "–†–∞–∫, –°–∫–æ—Ä–ø–∏–æ–Ω"
}

focus_options = [
    "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –≥–ª—É–±–∏–Ω–∞", "–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å", "–¢–≤–æ—Ä—á–µ—Å–∫–æ–µ —Å–∞–º–æ–≤—ã—Ä–∞–∂–µ–Ω–∏–µ",
    "–û–±—â–µ–Ω–∏–µ –∏ —Å–≤—è–∑–∏", "–°–µ–º–µ–π–Ω–æ–µ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏–µ", "–õ–∏—á–Ω–æ—Å—Ç–Ω—ã–π —Ä–æ—Å—Ç",
    "–î—É—Ö–æ–≤–Ω—ã–π –ø–æ–∏—Å–∫", "–§–∏–∑–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å", "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —É—Å–ø–µ—Ö",
    "–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –±–∞–ª–∞–Ω—Å", "–û—Ç–Ω–æ—à–µ–Ω–∏—è –∏ –¥—Ä—É–∂–±–∞", "–°–º–µ–ª—ã–µ —Ä–µ—à–µ–Ω–∏—è"
]

# --- –†–∞–±–æ—Ç–∞ —Å –∏—Å—Ç–æ—Ä–∏–µ–π ---
def load_history():
    if not os.path.exists(HISTORY_FILE):
        return set()
    try:
        with open(HISTORY_FILE, "r", encoding="utf-8") as f:
            raw = json.load(f)
        cutoff = datetime.now() - timedelta(days=HISTORY_DAYS)
        return {tuple(item["combo"]) for item in raw if datetime.fromisoformat(item["date"]) > cutoff}
    except Exception:
        return set()

def save_history(history):
    try:
        data = [{"combo": list(c), "date": datetime.now().isoformat()} for c in history]
        with open(HISTORY_FILE, "w", encoding="utf-8") as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
    except Exception:
        pass

used_combinations = load_history()

# --- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–≥–Ω–æ–∑–∞ —á–µ—Ä–µ–∑ GPT ---
def generate_prediction(sign: str) -> str:
    prompt = f"""
–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∫–æ—Ä–æ—Ç–∫–∏–π –≥–æ—Ä–æ—Å–∫–æ–ø-–ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è –∑–Ω–∞–∫–∞ {sign} –≤ —Å—Ç–∏–ª–µ –∏—Ä–æ–Ω–∏—á–Ω—ã—Ö –∑–∞–º–µ—Ç–æ–∫ –æ –∂–∏–∑–Ω–∏.
–£—Å–ª–æ–≤–∏—è:
- –¢–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –Ω–∏–∫–∞–∫–∏—Ö –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–ª–æ–≤.
- 1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º—É–º.
- –õ—ë–≥–∫–∞—è –∏—Ä–æ–Ω–∏—è, —é–º–æ—Ä –∏–ª–∏ —Å–∞—Ä–∫–∞–∑–º.
- –¢–µ–º–∞—Ç–∏–∫–∞: –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ—Å—Ç—å, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, —Å–ª—É—á–∞–π–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è, —Å—Ç—Ä–∞–Ω–Ω–æ—Å—Ç–∏ –¥–Ω—è.
- –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ñ–∏—Å–Ω—ã–π —Å—Ç–∏–ª—å.

–ü—Ä–∏–º–µ—Ä—ã:
- –í—ã –∏–∑ —Ç–µ—Ö, —á—Ç–æ –∏ —Ä—ã–±–∫—É –±–µ–∑ —Ç—Ä—É–¥–∞ –≤—ã–ª–æ–≤—è—Ç, –∏ –∫–ª–µ–≤–µ—Ä —á–µ—Ç—ã—Ä–µ—Ö–ª–∏—Å—Ç–Ω—ã–π –Ω–∞–π–¥—É—Ç. –¢–∞–∫–æ–π –≤–æ—Ç –¥–µ–Ω—å.
- –û—Ç–ª–æ–∂–∏–ª–∏ –≤—Å–µ —Å –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞ –Ω–∞ –≤—ã—Ö–æ–¥–Ω—ã–µ, –∏ –æ–Ω–∏, –±–ª–∏–Ω, –≤–∑—è–ª–∏ –∏ –Ω–∞—Å—Ç—É–ø–∏–ª–∏. –ß—Ç–æ –∑–∞ —Ç—Ä–µ—à.
- –í –≤–∞—à–µ–º —Å–ª–æ–≤–∞—Ä–Ω–æ–º –∑–∞–ø–∞—Å–µ —Å–∫–æ—Ä–æ –Ω–µ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –Ω–∏—á–µ–≥–æ, –∫—Ä–æ–º–µ –º–∞—Ç–æ–≤.
- –°–µ–≥–æ–¥–Ω—è –≤–∞—à–∞ –º–µ—á—Ç–∞ ‚Äî —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å –º—ã—à—Ü—ã —à–µ–∏ –∏ –ø–ª–µ—á–∏.
"""
    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[{"role": "user", "content": prompt}],
        temperature=0.9,
        max_tokens=45  # –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –¥–ª–∏–Ω—É –ø—Ä–æ–≥–Ω–æ–∑–∞
    )
    return response.choices[0].message.content.strip()


def generate_unique_combo(sign: str):
    for _ in range(4000):
        prediction = generate_prediction(sign)
        card = random.choice(tarot_cards)
        focus = random.choice(focus_options)
        combo = (prediction, card, focus)
        if combo not in used_combinations:
            used_combinations.add(combo)
            save_history(used_combinations)
            return prediction, card, focus
    used_combinations.clear()
    save_history(used_combinations)
    return generate_unique_combo(sign)

# --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ ---
def assert_channel_access():
    try:
        bot.get_chat(CHANNEL_ID)
    except Exception as e:
        raise SystemExit(f"‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–Ω–∞–ª—É: {e}\n–ü—Ä–æ–≤–µ—Ä—å ID –∏ –ø—Ä–∞–≤–∞ –±–æ—Ç–∞ (–±–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–¥–º–∏–Ω–æ–º).")

# --- –§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã ---
def russian_date():
    now = datetime.now()
    return f"{now.day} {MONTHS[now.month]}"

# --- –ì–ª–∞–≤–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ ---
def main():
    print("–ü—Ä–æ–≤–µ—Ä—è—é –¥–æ—Å—Ç—É–ø –∫ –∫–∞–Ω–∞–ª—É...")
    assert_channel_access()
    print("‚úÖ –î–æ—Å—Ç—É–ø –µ—Å—Ç—å. –ù–∞—á–∏–Ω–∞—é –æ—Ç–ø—Ä–∞–≤–∫—É...")

    for sign in signs:
        prediction, card, focus = generate_unique_combo(sign)
        sign_name = sign.split(" ")[1]  # –Ω–∞–ø—Ä–∏–º–µ—Ä "–û–≤–µ–Ω"
        date_str = russian_date()
        compatibility_text = compatibility.get(sign_name, "‚Äî")

        text = (
            f"{sign}, {date_str}\n\n"
            f"üí° –ü—Ä–æ–≥–Ω–æ–∑: {prediction}\n\n"
            f"üé¥ –ö–∞—Ä—Ç–∞ –¥–Ω—è: {card}\n\n"
            f"üéØ –§–æ–∫—É—Å –¥–Ω—è: {focus}\n"
            f"üíû –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: {compatibility_text}\n\n"
            f"üîÆ <a href=\"https://t.me/+QIQFGYWwkLhiYjFi\">–ù–∞—É—á–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø</a>"
        )

        try:
            bot.send_message(CHANNEL_ID, text, parse_mode="HTML", disable_web_page_preview=True)
            print(f"‚úî {sign} ‚Äî –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. –ö–∞—Ä—Ç–∞: {card} | –§–æ–∫—É—Å: {focus}")
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ {sign}: {e}")

        if SLEEP_SECONDS > 0:
            time.sleep(SLEEP_SECONDS)

    print("üéâ –ì–æ—Ç–æ–≤–æ ‚Äî –≤—Å–µ –≥–æ—Ä–æ—Å–∫–æ–ø—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã.")

if __name__ == "__main__":
    main()
